============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.1, pluggy-1.6.0 -- /home/engine/project/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/engine/project
configfile: pytest.ini
testpaths: tests
plugins: cov-7.0.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 95 items

tests/integration/test_purchase_workflow.py::test_purchase_workflow_creates_order_and_updates_vip FAILED [  1%]
tests/integration/test_referral_workflow.py::test_referral_workflow_tracks_cashback_and_blacklist PASSED [  2%]
tests/integration/test_refund_workflow.py::test_refund_workflow_credits_wallet_and_logs_audit PASSED [  3%]
tests/test_config.py::test_load_config_success PASSED                    [  4%]
tests/test_config.py::test_load_config_missing_file PASSED               [  5%]
tests/test_config.py::test_rate_limit_validation_errors PASSED           [  6%]
tests/test_database.py::test_update_wallet_balance_tracks_lifetime_spend PASSED [  7%]
tests/test_database.py::test_update_wallet_balance_negative_deltas_do_not_increase_lifetime PASSED [  8%]
tests/test_database.py::test_purchase_product_deducts_balance_and_creates_order PASSED [  9%]
tests/test_database.py::test_purchase_product_with_insufficient_funds_raises PASSED [ 10%]
tests/test_database.py::test_get_applicable_discounts_skips_expired_entries PASSED [ 11%]
tests/test_database.py::test_create_manual_order_updates_lifetime_not_wallet PASSED [ 12%]
tests/test_database.py::test_migration_v4_extends_tickets_table PASSED   [ 13%]
tests/test_database.py::test_create_ticket_with_defaults PASSED          [ 14%]
tests/test_database.py::test_create_ticket_with_all_fields PASSED        [ 15%]
tests/test_database.py::test_update_ticket_type PASSED                   [ 16%]
tests/test_database.py::test_update_ticket_assigned_staff PASSED         [ 17%]
tests/test_database.py::test_update_ticket_priority PASSED               [ 18%]
tests/test_database.py::test_update_ticket_order_id PASSED               [ 20%]
tests/test_database.py::test_update_ticket_closed_at PASSED              [ 21%]
tests/test_database.py::test_update_ticket_multiple_fields PASSED        [ 22%]
tests/test_database.py::test_update_ticket_status_preserves_other_fields PASSED [ 23%]
tests/test_database.py::test_ticket_fields_persist_across_operations PASSED [ 24%]
tests/test_database.py::test_migration_v6_extends_orders_table PASSED    [ 25%]
tests/test_database.py::test_create_order_with_status_and_warranty PASSED [ 26%]
tests/test_database.py::test_update_order_status PASSED                  [ 27%]
tests/test_database.py::test_renew_order_warranty PASSED                 [ 28%]
tests/test_database.py::test_get_orders_expiring_soon PASSED             [ 29%]
tests/test_database.py::test_get_active_orders PASSED                    [ 30%]
tests/test_logger.py::test_get_logger_returns_logger PASSED              [ 31%]
tests/test_logger.py::test_setup_logger_creates_configured_logger PASSED [ 32%]
tests/test_logger.py::test_discord_handler_creation PASSED               [ 33%]
tests/test_logger.py::test_discord_handler_with_bot PASSED               [ 34%]
tests/test_logger.py::test_logger_is_mocked_in_tests PASSED              [ 35%]
tests/test_payment_system.py::TestPaymentsConfig::test_load_valid_payments_config PASSED [ 36%]
tests/test_payment_system.py::TestPaymentsConfig::test_missing_file_raises_file_not_found PASSED [ 37%]
tests/test_payment_system.py::TestPaymentsConfig::test_missing_required_fields PASSED [ 38%]
tests/test_payment_system.py::TestPaymentsConfig::test_template_placeholder_validation PASSED [ 40%]
tests/test_payment_system.py::TestPaymentsConfig::test_payment_method_validation PASSED [ 41%]
tests/test_payment_system.py::TestPaymentsConfig::test_empty_payment_methods_allowed PASSED [ 42%]
tests/test_payment_system.py::TestPaymentsConfig::test_payment_method_optional_fields PASSED [ 43%]
tests/test_payment_system.py::test_wallet_payment_success_flow PASSED    [ 44%]
tests/test_payment_system.py::test_wallet_payment_failure_recovery PASSED [ 45%]
tests/test_payment_system.py::test_payment_method_enabled_flag_is_preserved PASSED [ 46%]
tests/test_products_template.py::test_template_headers_match_importer PASSED [ 47%]
tests/test_products_template.py::test_template_csv_export_compatibility PASSED [ 48%]
tests/test_products_template.py::test_template_headers_database_alignment PASSED [ 49%]
tests/test_products_template.py::test_price_conversion_validation PASSED [ 50%]
tests/test_products_template.py::test_required_field_validation PASSED   [ 51%]
tests/test_referrals.py::test_get_all_pending_referral_cashbacks PASSED  [ 52%]
tests/test_referrals.py::test_get_pending_cashback_for_user PASSED       [ 53%]
tests/test_referrals.py::test_mark_cashback_paid PASSED                  [ 54%]
tests/test_referrals.py::test_blacklisted_user_excluded_from_pending PASSED [ 55%]
tests/test_referrals.py::test_zero_pending_cashback PASSED               [ 56%]
tests/test_referrals.py::test_multiple_purchases_accumulate PASSED       [ 57%]
tests/test_referrals.py::test_partial_payment_tracking PASSED            [ 58%]
tests/test_referrals.py::test_create_referral_prevents_self_referral PASSED [ 60%]
tests/test_referrals.py::test_duplicate_referral_prevention PASSED       [ 61%]
tests/test_referrals.py::test_get_referrer_for_user_returns_assignment PASSED [ 62%]
tests/test_refunds.py::test_create_refund_request_calculates_handling_fee PASSED [ 63%]
tests/test_refunds.py::test_validate_order_for_refund_enforces_time_window PASSED [ 64%]
tests/test_refunds.py::test_approve_refund_updates_wallet_and_logs_transaction PASSED [ 65%]
tests/test_refunds.py::test_reject_refund_records_reason PASSED          [ 66%]
tests/test_refunds.py::test_get_pending_refunds_returns_only_open_items PASSED [ 67%]
tests/test_storefront.py::test_get_distinct_main_categories_returns_sorted_unique PASSED [ 68%]
tests/test_storefront.py::test_get_products_by_category_filters_inactive_entries PASSED [ 69%]
tests/test_storefront.py::test_bulk_upsert_products_tracks_counts PASSED [ 70%]
tests/test_tickets.py::test_parse_timestamp_with_datetime_object_aware PASSED [ 71%]
tests/test_tickets.py::test_parse_timestamp_with_datetime_object_naive PASSED [ 72%]
tests/test_tickets.py::test_parse_timestamp_with_iso_format_string PASSED [ 73%]
tests/test_tickets.py::test_parse_timestamp_with_space_separated_string PASSED [ 74%]
tests/test_tickets.py::test_parse_timestamp_with_timezone_aware_string PASSED [ 75%]
tests/test_tickets.py::test_parse_timestamp_with_invalid_type_raises PASSED [ 76%]
tests/test_tickets.py::test_parse_timestamp_preserves_microseconds PASSED [ 77%]
tests/test_tickets.py::test_parse_timestamp_normalizes_to_utc PASSED     [ 78%]
tests/test_tickets.py::test_ticket_counter_generates_unique_values PASSED [ 80%]
tests/test_tickets.py::test_create_ticket_with_counter_returns_sequence PASSED [ 81%]
tests/test_tickets.py::test_touch_ticket_activity_updates_timestamp PASSED [ 82%]
tests/test_tickets.py::test_save_and_retrieve_transcripts PASSED         [ 83%]
tests/test_vip_tiers.py::test_calculate_vip_tier_returns_highest_role PASSED [ 84%]
tests/test_vip_tiers.py::test_process_post_purchase_detects_promotion PASSED [ 85%]
tests/test_vip_tiers.py::test_manual_role_assignment_helpers PASSED      [ 86%]
tests/test_wallet.py::test_migration_v5_creates_wallet_transactions_table PASSED [ 87%]
tests/test_wallet.py::test_concurrent_wallet_updates_are_thread_safe PASSED [ 88%]
tests/test_wallet.py::test_negative_deltas_do_not_increase_lifetime_spend PASSED [ 89%]
tests/test_wallet.py::test_purchase_product_prevents_negative_balances PASSED [ 90%]
tests/test_wallet.py::test_log_wallet_transaction PASSED                 [ 91%]
tests/test_wallet.py::test_get_wallet_transactions_pagination PASSED     [ 92%]
tests/test_wallet.py::test_purchase_product_logs_transaction PASSED      [ 93%]
tests/test_wallet.py::test_wallet_transaction_with_metadata PASSED       [ 94%]
tests/test_wallet.py::test_get_orders_for_user PASSED                    [ 95%]
tests/test_wallet.py::test_get_order_by_id PASSED                        [ 96%]
tests/test_wallet.py::test_get_ticket_by_order_id PASSED                 [ 97%]
tests/test_wallet.py::test_wallet_transaction_links_to_ticket PASSED     [ 98%]
tests/test_wallet.py::test_orders_pagination PASSED                      [100%]

=================================== FAILURES ===================================
_____________ test_purchase_workflow_creates_order_and_updates_vip _____________
tests/integration/test_purchase_workflow.py:10: in test_purchase_workflow_creates_order_and_updates_vip
    await db._connection.execute(
.venv/lib/python3.12/site-packages/aiosqlite/core.py:183: in execute
    cursor = await self._execute(self._conn.execute, sql, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/aiosqlite/core.py:122: in _execute
    return await future
           ^^^^^^^^^^^^
.venv/lib/python3.12/site-packages/aiosqlite/core.py:105: in run
    result = function()
             ^^^^^^^^^^
E   sqlite3.OperationalError: unrecognized token: "5_000"
---------------------------- Captured stdout setup -----------------------------
[2025-12-03 11:15:09,196] INFO:apex_core: Current database schema version: 0
[2025-12-03 11:15:09,196] INFO:apex_core: Applying migration v1: base_schema
[2025-12-03 11:15:09,198] INFO:apex_core: Migration v1 applied successfully
[2025-12-03 11:15:09,198] INFO:apex_core: Applying migration v2: migrate_products_table
[2025-12-03 11:15:09,199] INFO:apex_core: Migration v2 applied successfully
[2025-12-03 11:15:09,199] INFO:apex_core: Applying migration v3: migrate_discounts_indexes
[2025-12-03 11:15:09,200] INFO:apex_core: Migration v3 applied successfully
[2025-12-03 11:15:09,200] INFO:apex_core: Applying migration v4: extend_tickets_schema
[2025-12-03 11:15:09,202] INFO:apex_core: Migration v4 applied successfully
[2025-12-03 11:15:09,202] INFO:apex_core: Applying migration v5: wallet_transactions_table
[2025-12-03 11:15:09,203] INFO:apex_core: Migration v5 applied successfully
[2025-12-03 11:15:09,203] INFO:apex_core: Applying migration v6: extend_orders_schema
[2025-12-03 11:15:09,208] INFO:apex_core: Migration v6 applied successfully
[2025-12-03 11:15:09,208] INFO:apex_core: Applying migration v7: transcripts_table
[2025-12-03 11:15:09,209] INFO:apex_core: Migration v7 applied successfully
[2025-12-03 11:15:09,209] INFO:apex_core: Applying migration v8: ticket_counter_table
[2025-12-03 11:15:09,210] INFO:apex_core: Migration v8 applied successfully
[2025-12-03 11:15:09,210] INFO:apex_core: Applying migration v9: refunds_table
[2025-12-03 11:15:09,212] INFO:apex_core: Migration v9 applied successfully
[2025-12-03 11:15:09,212] INFO:apex_core: Applying migration v10: referrals_table
[2025-12-03 11:15:09,213] INFO:apex_core: Migration v10 applied successfully
[2025-12-03 11:15:09,213] INFO:apex_core: Applying migration v11: permanent_messages_table
[2025-12-03 11:15:09,215] INFO:apex_core: Migration v11 applied successfully
[2025-12-03 11:15:09,215] INFO:apex_core: Database schema migration complete. Final version: 11
=============================== warnings summary ===============================
.venv/lib/python3.12/site-packages/discord/player.py:30
  /home/engine/project/.venv/lib/python3.12/site-packages/discord/player.py:30: DeprecationWarning: 'audioop' is deprecated and slated for removal in Python 3.13
    import audioop

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.12.3-final-0 ________________

Name                                          Stmts   Miss  Cover   Missing
---------------------------------------------------------------------------
apex_core/__init__.py                             4      0   100%
apex_core/config.py                             172     24    86%   110, 159, 171, 173, 182-183, 193-205, 272-279
apex_core/database.py                           755    227    70%   42, 70, 81, 106-108, 113, 124, 199, 207-261, 266, 291, 326, 368, 413, 450, 478, 529, 573, 586, 591, 601, 655, 688, 703, 731, 758, 769-776, 790, 824, 839-848, 853, 868-881, 888, 909-922, 942-983, 990-1011, 1014-1026, 1030, 1043-1044, 1048, 1061-1064, 1082, 1097-1098, 1126, 1149-1162, 1166, 1178, 1181, 1203, 1216-1227, 1241, 1247-1248, 1271, 1286, 1341, 1369, 1413, 1471-1472, 1493, 1527-1546, 1553-1554, 1566-1568, 1580, 1591-1592, 1658-1659, 1671, 1686, 1700, 1710, 1721, 1741, 1777-1779, 1784, 1804, 1816, 1837, 1854, 1864-1871, 1886, 1921, 1933-1934, 1979-1981, 1991, 2012-2037, 2042, 2059, 2081, 2111, 2153, 2170-2171, 2210, 2227, 2256-2257, 2268-2280, 2292, 2316, 2336, 2373, 2434, 2451, 2510-2522, 2533-2546, 2561-2573, 2582-2593, 2601-2608, 2620-2633
apex_core/financial_cooldown_manager.py         176    176     0%   3-356
apex_core/logger.py                              60     25    58%   31-53, 96-106
apex_core/utils/__init__.py                       7      0   100%
apex_core/utils/vip.py                           12      0   100%
tests/__init__.py                                 0      0   100%
tests/conftest.py                               125     12    90%   61, 64, 73, 87, 93, 99, 107, 120-121, 124-125, 138
tests/integration/test_purchase_workflow.py      17     11    35%   14-42
tests/integration/test_referral_workflow.py      17      0   100%
tests/integration/test_refund_workflow.py        17      0   100%
tests/test_config.py                             39      0   100%
tests/test_database.py                          256      0   100%
tests/test_logger.py                             27      0   100%
tests/test_payment_system.py                    134      0   100%
tests/test_products_template.py                  55      1    98%   158
tests/test_referrals.py                         186      0   100%
tests/test_refunds.py                            65      0   100%
tests/test_storefront.py                         26      0   100%
tests/test_tickets.py                            82      0   100%
tests/test_vip_tiers.py                          27      0   100%
tests/test_wallet.py                            135      0   100%
---------------------------------------------------------------------------
TOTAL                                          2394    476    80%
Required test coverage of 80% reached. Total coverage: 80.12%
=========================== short test summary info ============================
FAILED tests/integration/test_purchase_workflow.py::test_purchase_workflow_creates_order_and_updates_vip
=================== 1 failed, 94 passed, 1 warning in 5.97s ====================
