============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0 -- /home/engine/project/.venv/bin/python
cachedir: .pytest_cache
rootdir: /home/engine/project
configfile: pytest.ini
plugins: cov-7.0.0, anyio-4.12.0, asyncio-1.3.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 1 item

tests/test_database.py::test_update_order_status FAILED                  [100%]
ERROR: Coverage failure: total of 12 is less than fail-under=80


=================================== FAILURES ===================================
___________________________ test_update_order_status ___________________________

db = <apex_core.database.Database object at 0x7ff002f8f250>

    @pytest.mark.asyncio
    async def test_update_order_status(db):
        """Test updating order status with validation."""
        await db.ensure_user(65432)
    
        product_id = await db.create_product(
            main_category="Test",
            sub_category="Service",
            service_name="Test Service",
            variant_name="Test Variant",
            price_cents=1000,
        )
    
        order_id = await db.create_order(
            user_discord_id=65432,
            product_id=product_id,
            price_paid_cents=1000,
            discount_applied_percent=0.0,
        )
    
        # Test valid status update
>       await db.update_order_status(order_id, "fulfilled")

tests/test_database.py:448: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
apex_core/database.py:3553: in update_order_status
    await self._connection.execute(
.venv/lib/python3.11/site-packages/aiosqlite/core.py:194: in execute
    cursor = await self._execute(self._conn.execute, sql, parameters)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.11/site-packages/aiosqlite/core.py:133: in _execute
    return await future
           ^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

tx = <_queue.SimpleQueue object at 0x7ff00314bba0>

    def _connection_worker_thread(
        tx: SimpleQueue[tuple[asyncio.Future, Callable[[], Any]]],
    ):
        """
        Execute function calls on a separate thread.
    
        :meta private:
        """
        while True:
            # Continues running until all queue items are processed,
            # even after connection is closed (so we can finalize all
            # futures)
    
            tx_item = tx.get()
            future, function = tx_item
    
            try:
                LOG.debug("executing %s", function)
>               result = function()
                         ^^^^^^^^^^
E               sqlite3.OperationalError: no such column: updated_at

.venv/lib/python3.11/site-packages/aiosqlite/core.py:65: OperationalError
---------------------------- Captured stdout setup -----------------------------
[2025-12-15 06:53:56,442] INFO:apex_core: Current database schema version: 0
[2025-12-15 06:53:56,442] INFO:apex_core: Applying migration v1: base_schema
[2025-12-15 06:53:56,443] INFO:apex_core: Migration v1: base_schema applied successfully
[2025-12-15 06:53:56,443] INFO:apex_core: Applying migration v2: migrate_products_table
[2025-12-15 06:53:56,444] INFO:apex_core: Migration v2: migrate_products_table applied successfully
[2025-12-15 06:53:56,444] INFO:apex_core: Applying migration v3: migrate_discounts_indexes
[2025-12-15 06:53:56,446] INFO:apex_core: Migration v3: migrate_discounts_indexes applied successfully
[2025-12-15 06:53:56,446] INFO:apex_core: Applying migration v4: extend_tickets_schema
[2025-12-15 06:53:56,449] INFO:apex_core: Migration v4: extend_tickets_schema applied successfully
[2025-12-15 06:53:56,449] INFO:apex_core: Applying migration v5: wallet_transactions_table
[2025-12-15 06:53:56,450] INFO:apex_core: Migration v5: wallet_transactions_table applied successfully
[2025-12-15 06:53:56,450] INFO:apex_core: Applying migration v6: extend_orders_schema
[2025-12-15 06:53:56,452] INFO:apex_core: Migration v6: extend_orders_schema applied successfully
[2025-12-15 06:53:56,452] INFO:apex_core: Applying migration v7: transcripts_table
[2025-12-15 06:53:56,453] INFO:apex_core: Migration v7: transcripts_table applied successfully
[2025-12-15 06:53:56,453] INFO:apex_core: Applying migration v8: ticket_counter_table
[2025-12-15 06:53:56,454] INFO:apex_core: Migration v8: ticket_counter_table applied successfully
[2025-12-15 06:53:56,454] INFO:apex_core: Applying migration v9: refunds_table
[2025-12-15 06:53:56,455] INFO:apex_core: Migration v9: refunds_table applied successfully
[2025-12-15 06:53:56,455] INFO:apex_core: Applying migration v10: referrals_table
[2025-12-15 06:53:56,456] INFO:apex_core: Migration v10: referrals_table applied successfully
[2025-12-15 06:53:56,456] INFO:apex_core: Applying migration v11: permanent_messages_table
[2025-12-15 06:53:56,457] INFO:apex_core: Migration v11: permanent_messages_table applied successfully
[2025-12-15 06:53:56,457] INFO:apex_core: Applying migration v12: wallet_transactions_user_created_index
[2025-12-15 06:53:56,458] INFO:apex_core: Migration v12: wallet_transactions_user_created_index applied successfully
[2025-12-15 06:53:56,458] INFO:apex_core: Applying migration v13: setup_sessions_table
[2025-12-15 06:53:56,459] INFO:apex_core: Migration v13: setup_sessions_table applied successfully
[2025-12-15 06:53:56,459] INFO:apex_core: Applying migration v14: inventory_stock_tracking
[2025-12-15 06:53:56,460] INFO:apex_core: Added stock_quantity column to products table
[2025-12-15 06:53:56,460] INFO:apex_core: Migration v14: inventory_stock_tracking applied successfully
[2025-12-15 06:53:56,460] INFO:apex_core: Applying migration v15: promo_codes_system
[2025-12-15 06:53:56,461] INFO:apex_core: Created promo codes system tables
[2025-12-15 06:53:56,461] INFO:apex_core: Migration v15: promo_codes_system applied successfully
[2025-12-15 06:53:56,461] INFO:apex_core: Applying migration v16: gift_system
[2025-12-15 06:53:56,461] INFO:apex_core: Created gift system tables
[2025-12-15 06:53:56,462] INFO:apex_core: Migration v16: gift_system applied successfully
[2025-12-15 06:53:56,462] INFO:apex_core: Applying migration v17: announcements_table
[2025-12-15 06:53:56,462] INFO:apex_core: Created announcements table
[2025-12-15 06:53:56,462] INFO:apex_core: Migration v17: announcements_table applied successfully
[2025-12-15 06:53:56,462] INFO:apex_core: Applying migration v18: orders_status_tracking
[2025-12-15 06:53:56,464] INFO:apex_core: Added status tracking columns to orders table
[2025-12-15 06:53:56,464] INFO:apex_core: Migration v18: orders_status_tracking applied successfully
[2025-12-15 06:53:56,464] INFO:apex_core: Applying migration v19: reviews_system
[2025-12-15 06:53:56,465] INFO:apex_core: Created reviews system table
[2025-12-15 06:53:56,465] INFO:apex_core: Migration v19: reviews_system applied successfully
[2025-12-15 06:53:56,465] INFO:apex_core: Applying migration v20: supplier_tracking
[2025-12-15 06:53:56,467] INFO:apex_core: Added supplier tracking to products table and created suppliers table
[2025-12-15 06:53:56,468] INFO:apex_core: Migration v20: supplier_tracking applied successfully
[2025-12-15 06:53:56,468] INFO:apex_core: Applying migration v21: ai_support_system
[2025-12-15 06:53:56,468] INFO:apex_core: Created AI support system tables
[2025-12-15 06:53:56,469] INFO:apex_core: Migration v21: ai_support_system applied successfully
[2025-12-15 06:53:56,469] INFO:apex_core: Applying migration v22: wishlist_and_tags
[2025-12-15 06:53:56,471] INFO:apex_core: Created wishlist, product tags, and PIN security tables
[2025-12-15 06:53:56,472] INFO:apex_core: Migration v22: wishlist_and_tags applied successfully
[2025-12-15 06:53:56,472] INFO:apex_core: Applying migration v23: atto_integration
[2025-12-15 06:53:56,472] INFO:apex_core: Created Atto integration tables (main wallet system)
[2025-12-15 06:53:56,473] INFO:apex_core: Migration v23: atto_integration applied successfully
[2025-12-15 06:53:56,473] INFO:apex_core: Applying migration v24: crypto_wallets
[2025-12-15 06:53:56,473] INFO:apex_core: Created crypto wallet and transaction verification tables
[2025-12-15 06:53:56,474] INFO:apex_core: Migration v24: crypto_wallets applied successfully
[2025-12-15 06:53:56,474] INFO:apex_core: Database schema migration complete. Final version: 24
================================ tests coverage ================================
_______________ coverage: platform linux, python 3.11.14-final-0 _______________

Name                                       Stmts   Miss  Cover   Missing
------------------------------------------------------------------------
apex_core/__init__.py                          5      0   100%
apex_core/config.py                          337    205    39%   162-165, 169, 176-190, 194-244, 249-275, 284-297, 302-318, 323-337, 342-354, 359-371, 376-394, 402-411, 418-437, 442-456, 461-475, 480-502, 511-535
apex_core/config_writer.py                    79     55    30%   29-38, 50-51, 55, 63-71, 89-126, 140-144, 157, 170, 183, 196, 204-210, 227-228
apex_core/constants.py                        35     35     0%   3-92
apex_core/database.py                       1515   1123    26%   30, 49-57, 61-87, 97, 125, 136, 174-179, 186, 197, 272, 280-334, 339, 364, 399, 441, 486, 523, 551, 602, 646, 659, 664, 673-722, 737-783, 792-804, 807-818, 843, 871, 896, 907-914, 927-947, 961-974, 977-986, 990-1002, 1006-1019, 1025-1036, 1047-1060, 1080-1121, 1128-1149, 1152-1164, 1167-1182, 1185-1216, 1219-1250, 1263-1284, 1287-1300, 1303-1310, 1315-1337, 1340-1351, 1354-1365, 1378-1419, 1423-1460, 1478-1493, 1507, 1550-1612, 1630-1706, 1717-1799, 1808-1820, 1823-1834, 1837-1844, 1847-1854, 1858-1869, 1878-1917, 1921-1937, 1941-1961, 1974-1987, 1991-1998, 2002-2009, 2023-2048, 2058-2119, 2128-2142, 2150-2175, 2179-2192, 2196-2209, 2218-2233, 2248-2275, 2291-2332, 2348-2378, 2395-2396, 2407-2419, 2430-2443, 2454-2466, 2474-2493, 2511-2552, 2572-2585, 2590, 2628, 2641, 2702-2714, 2725-2738, 2753-2765, 2774-2785, 2793-2800, 2812-2825, 2844-2857, 2883-2904, 2916-2928, 2952-2985, 2997-3008, 3016-3026, 3034-3045, 3059-3067, 3079-3104, 3115-3129, 3137-3148, 3177-3198, 3202-3209, 3213-3222, 3236-3301, 3311-3337, 3341-3349, 3353-3361, 3365-3385, 3414-3432, 3436-3443, 3451-3493, 3497-3508, 3512-3523, 3527-3535, 3551, 3564-3566, 3570-3577, 3599-3615, 3625-3639, 3648-3659, 3664, 3683, 3733, 3766, 3797, 3828, 3864, 3922, 3959-3960, 3976, 4043, 4091-4108, 4119-4130, 4134-4141, 4145-4151, 4169-4205, 4209-4216, 4225-4238, 4242-4254, 4266-4294, 4307-4325, 4341-4358, 4369-4413, 4426, 4433-4436, 4457-4464, 4473-4502, 4506-4522, 4528-4540, 4544-4556, 4560-4573, 4577-4584, 4590-4602, 4606-4618, 4622-4630, 4634-4646, 4652-4672, 4676-4721, 4727-4734, 4738-4746, 4750-4777, 4781-4799, 4803-4810, 4814-4830, 4838-4850, 4854-4861, 4874-4886, 4890-4897, 4903-4919, 4935-4947, 4959-4971
apex_core/financial_cooldown_manager.py      188    188     0%   3-404
apex_core/logger.py                           83     58    30%   26-28, 33-62, 66-88, 92-96, 122-154
apex_core/server_blueprint.py                 38     38     0%   7-778
apex_core/supplier_apis.py                   363    363     0%   3-679
apex_core/utils/__init__.py                    9      9     0%   3-12
apex_core/utils/admin_checks.py               19     19     0%   3-30
apex_core/utils/error_messages.py              9      9     0%   3-28
apex_core/utils/permissions.py                24     24     0%   3-92
apex_core/utils/vip.py                        12     12     0%   3-33
tests/__init__.py                              0      0   100%
tests/conftest.py                            125     55    56%   49-50, 55-58, 61, 64, 69-70, 73, 78-81, 84, 87, 90, 93, 96, 99, 104, 107, 112-115, 120-121, 124-125, 130-133, 138, 143-147, 152, 190-205, 252-258, 263-278
tests/test_bot_token.py                       59     59     0%   1-96
tests/test_bypass_logging.py                 164    164     0%   3-265
tests/test_config.py                         121    121     0%   1-232
tests/test_database.py                       460    374    19%   10-19, 24-30, 35-67, 72-93, 98-129, 134-158, 164-171, 177-195, 201-222, 228-240, 246-257, 263-274, 280-291, 297-309, 315-337, 343-360, 366-382, 389-395, 401-424, 449-454, 460-499, 506-538, 544-576, 582-619, 625-660, 666-680, 686-706, 712-732, 738-757, 763-782, 788-803, 809-814, 820-823, 829-846, 852-869, 875-892, 898-919, 925-931, 937
tests/test_financial_cooldown_manager.py     247    247     0%   3-426
tests/test_logger.py                          28     28     0%   3-47
tests/test_panel_validators.py                68     68     0%   1-134
tests/test_payment_system.py                 134    134     0%   3-301
tests/test_products_template.py               55     55     0%   1-158
tests/test_referrals.py                      186    186     0%   3-313
tests/test_refunds.py                         65     65     0%   1-157
tests/test_setup.py                          957    957     0%   3-1861
tests/test_storage.py                        138    138     0%   3-284
tests/test_storefront.py                     159    159     0%   1-448
tests/test_tickets.py                        188    188     0%   1-325
tests/test_vip_tiers.py                       27     27     0%   1-44
tests/test_wallet.py                         135    135     0%   1-317
------------------------------------------------------------------------
TOTAL                                       6032   5298    12%
FAIL Required test coverage of 80% not reached. Total coverage: 12.17%
=========================== short test summary info ============================
FAILED tests/test_database.py::test_update_order_status - sqlite3.OperationalError: no such column: updated_at
============================== 1 failed in 0.84s ===============================
